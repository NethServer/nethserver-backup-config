Upgrade NS6 using rsync
=======================

This procedure can be used to upgrade a running NethServer 6 to a new server running NethServer 7.
The process is much faster than a traditional backup and restore, also it minimizes the downtime for the users.

What you need

- A running NethServer 6 installation, we will call it original server or source server
- A running NethServer 7 installation with at least the same disk space of the source server, we will call it destination server
- Both machines must be network connected.

Preliminary steps
----------------

Install NethServer 7 on a new machine, make sure you can reach the original server from it.
The source server must allow root login via SSH key and password.

Sync files
----------

The synchronization script copies data using rsync over SSH.
If the destination server doesn't have any SSH keys, the script will also a pair of RSA keys and copy the public key to the source server.
All directories excluded from the backup data will not be synced.

On the target machine, execute the following command: ::

  screen rsync-upgrade <source_server_name> [ssh_port]

Where

- ``source_server_name`` is the host name or IP of the original server
- ``ssh_port`` is the SSH port of the original server (default is 22)

Example: ::

    screen rsync-upgrade mail.nethserver.org 2222

When asked, insert the root password of the source server, make a coffee and wait patiently.

The script will not perform any action on the source machine and can be invoked multiple times.

Sync and upgrade
----------------

If called with ``-u`` option, ``rsync-upgrade`` will execute a final synchronization and upgrade
the target machine.

Example: ::

    screen rsync-upgrade -u mail.nethserver.org 2222

The script will:

- close access to every network service on the source machine (except for SSH and httpd-admin)
- execute ``pre-backup-config`` and ``pre-backup-data`` event on the source machine
- sync all remaining data
- execute ``restore-config`` on the destination machine
- if the network can be automatically reconfigured, the script will also call ``post-restore-data`` event on the destination machine,
  otherwise follow the instructions generated by the script
